name: Deploy Weekly to CapRover

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'Dockerfile'
      - 'nginx.conf'
      - 'supervisord.conf'
      - 'docker-compose.yml'
      - 'captain-definition'
      - '.github/workflows/deploy.yml'
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  deploy-unified:
    name: Deploy Unified App (Backend + Frontend)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create unified tarball
        run: |
          # Crear tarball con todo el proyecto (backend + frontend + configs)
          tar -czf weekly-unified.tar.gz \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='*.log' \
            --exclude='.env*' \
            --exclude='*.md' \
            --exclude='*.sh' \
            --exclude='*.txt' \
            --exclude='*.puml' \
            --exclude='*.tar.gz' \
            --exclude='dist' \
            --exclude='build' \
            --exclude='.github' \
            --exclude='.vscode' \
            --exclude='.idea' \
            backend/ \
            frontend/ \
            Dockerfile \
            nginx.conf \
            supervisord.conf \
            captain-definition \
            docker-compose.yml \
            .dockerignore \
            package.json
          
          # Verificar que los archivos del frontend est√°n incluidos
          echo "üì¶ Verificando contenido del tarball..."
          echo "Archivos de frontend incluidos:"
          tar -tzf weekly-unified.tar.gz | grep "frontend/src/pages" | head -10
          echo ""
          echo "Tama√±o del tarball:"
          ls -lh weekly-unified.tar.gz

      - name: Deploy to CapRover via Webhook
        env:
          CAPROVER_WEBHOOK_URL: ${{ secrets.CAPROVER_WEBHOOK_URL }}
        run: |
          echo "üöÄ Triggering CapRover build via webhook..."
          
          # Verificar que el tarball existe
          if [ ! -f weekly-unified.tar.gz ]; then
            echo "‚ùå Error: weekly-unified.tar.gz no encontrado"
            exit 1
          fi
          
          # Obtener tama√±o del archivo
          FILE_SIZE=$(stat -f%z weekly-unified.tar.gz 2>/dev/null || stat -c%s weekly-unified.tar.gz 2>/dev/null || echo "unknown")
          echo "üì¶ Tarball size: $FILE_SIZE bytes"
          
          # Enviar tarball directamente como multipart/form-data
          # CapRover espera el archivo en el campo 'tarFile'
          # Agregar timestamp para forzar rebuild sin cache
          TIMESTAMP=$(date +%s)
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -F "tarFile=@weekly-unified.tar.gz" \
            -F "forceBuild=1" \
            "$CAPROVER_WEBHOOK_URL?t=$TIMESTAMP")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "üì° HTTP Status: $HTTP_CODE"
          echo "üìÑ Response: $BODY"
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "‚úÖ Build triggered successfully!"
          else
            echo "‚ùå Build trigger failed with HTTP $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Health check
        env:
          CAPROVER_SERVER_URL: ${{ secrets.CAPROVER_SERVER_URL }}
          CAPROVER_APP_NAME: ${{ secrets.CAPROVER_APP_NAME || 'weekly-app' }}
        run: |
          echo "üè• Waiting for app to be ready..."
          sleep 45
          
          # Intentar health check (ajusta la URL seg√∫n tu configuraci√≥n)
          if [ -n "$CAPROVER_SERVER_URL" ]; then
            HEALTH_URL="https://${CAPROVER_APP_NAME:-weekly-app}.${CAPROVER_SERVER_URL#https://}"
            HEALTH_URL="${HEALTH_URL#https://https://}"
            HEALTH_URL="https://${HEALTH_URL}"
          else
            HEALTH_URL="https://weekly-app.panel.getdevtools.com"
          fi
          
          echo "Checking health at: $HEALTH_URL/health"
          if curl -f "$HEALTH_URL/health" 2>/dev/null; then
            echo "‚úÖ Health check passed!"
          else
            echo "‚ö†Ô∏è  Health check failed or endpoint not available"
            echo "This is normal if the app is still building"
          fi
